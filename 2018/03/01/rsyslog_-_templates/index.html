<!DOCTYPE html>
<html lang="ko">

<head>
  <!-- Meta -->
  <meta charset="UTF-8">
  <meta name="author" content="ujuc">
  <meta name="description" content="Posts and writings by ujuc">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Style sheet -->

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" crossorigin="anonymous">

  <!-- Google web font -->
  <link rel="stylesheet" type="text/css" href="https://ujuc.github.io/theme/css/font_style.css">

  <!-- Style -->
  <link rel="stylesheet" type="text/css" href="https://ujuc.github.io/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://ujuc.github.io/theme/css/pygments.css">

  <!-- Feed -->
    <link href="https://ujuc.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="잘 밤에 쓸데없는 생각하기... ATOM" />
    <link href="https://ujuc.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="잘 밤에 쓸데없는 생각하기... RSS" />


  <title>
    잘 밤에 쓸데없는 생각하기...
  </title>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58634276-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
  <body>
  <header>
    <div class="container" style="margin-top: 10px;">
      <nav class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="fas fa-inbox"></i> <span class="hidden-xs">Blog</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/archives.html">
              <i class="fas fa-archive"></i> <span class="hidden-xs">Archive</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/tags.html">
              <i class="fas fa-tags"></i> <span class="hidden-xs">Tags</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/categories.html">
              <i class="fas fa-folder-open"></i> <span class="hidden-xs">Categories</span>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-toggle="dropdown" role="button">Pages</a>
            <div class="dropdown-menu">
            </div>
          </li>
      </nav>
    </div>
  </header>

  <div id="site_article" class="container">
    <article>
  <div class="col-xs-offset-1 col-md-offset-1 col-xs-10 col-md-10">
    <div class="row article_title">
      <h1><a href="https://ujuc.github.io/2018/03/01/rsyslog_-_templates/" class="h1"><span class="caps">RSYSLOG</span> -&nbsp;Templates</a></h1>
    </div>
    <div class="row">
      <p><i class="fas fa-poo"></i></p>
    </div>
    <div class="row article">
      <div class="article_text">
        <p><code>/var/log/syslog</code>로 모여드는 서비스들의 로그를 다른 곳으로 옮기고, 해당 내용을 확인하기 위해 파싱을 할 수 있도록 변경하는 작업이 필요했다.<br>
그래서 내가 필요한 로그를 syslog에서 때어낸후 다른 파일로 옮기는 작업을 성공. 하지만 그 이상의 작업을 하기위해서는 rsyslog에서 template을 작성하여야 내가 필요한 메시지만 작성할 수 있는 것을 확인하였기에 해당 부분을 찾아&nbsp;변경하였다.</p>
<p>그러면서 참고하려고 했던 문서들이 전부 영문이라. 한국어로 내가 정리해두고 나중에 또 찾아봐야겠다는 생각에서 글을&nbsp;작성한다.</p>
<h2 id="template">Template</h2>
<p>Rsyslog에서는 기본적인 포맷이 아닌 사용자가 필요한 내용으로 포맷을 변경할 수 있는 옵션을&nbsp;제공한다.</p>
<p>작성하는 포맷은 두가지가 있으며, 검색해보면 전부 Legacy 포맷으로 적도록 되어있으니 두개는 보기 편한걸로 작성해두면 될것으로&nbsp;보인다.</p>
<h3 id="template-statement"><code>template()</code> statement</h3>
<p>문서상으로는 7버전 이상에서 사용할 수 있는&nbsp;포맷이다.</p>
<p>아래의 예제는 파일에 로그를 작성하는 기본&nbsp;템플릿이다.</p>
<div class="codehilite"><pre><span></span>template(name=&quot;FileFormat&quot; type=&quot;list&quot;) {
    property(name=&quot;timestamp&quot; dateFormat=&quot;rfc3339&quot;)
    constant(value=&quot; &quot;)
    property(name=&quot;hostname&quot;)
    constant(value=&quot; &quot;)
    property(name=&quot;syslogtag&quot;)
    property(name=&quot;msg&quot; spifno1stsp=&quot;on&quot; )
    property(name=&quot;msg&quot; droplastlf=&quot;on&quot; )
    constant(value=&quot;\n&quot;)
    }
</pre></div>


<p>작성된 템플릿을 이용해서&nbsp;분석해보자.</p>
<ul>
<li><code>template(parameters) { list-descriptions }</code><ul>
<li>이런 구조로&nbsp;작성된다.</li>
</ul>
</li>
</ul>
<h4 id="parameters"><code>parameters</code></h4>
<ul>
<li><code>name</code>: 해당 템플릿의&nbsp;이름이다.</li>
<li><code>type</code>: 템플릿을 어떤 용도로 사용할 것인가에 대한 내용을 작성한다고&nbsp;보면된다.</li>
<li><code>option</code>: 템플릿을 어떤 형식으로 출력할 것인지에대해서 추가로 정할 수&nbsp;있다.</li>
</ul>
<h5 id="type"><code>type</code></h5>
<ul>
<li><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#list"><code>list</code></a><ul>
<li><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#constant-statement"><code>constant</code></a><ul>
<li>상수 텍스트에 대한 내용들을&nbsp;작성한다.</li>
<li><code>\n</code>, <code>\ooo</code>, <code>\xhh</code>, <code></code> 와 같은 내용들을 작성해 둘 수&nbsp;있다.</li>
<li>그리고 다음 파라미터를 입력하여 사용할 수도 있다.<ul>
<li><code>value</code> - 사용하는 상수&nbsp;값</li>
<li><code>outname</code> - 출력 필드&nbsp;이름</li>
<li><code>format</code> - <code>jsonf</code>나 그냥&nbsp;빈칸</li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#property-statement"><code>property</code></a><ul>
<li>속성에 대한 내용들을&nbsp;작성한다.</li>
<li>해당 내용은 종류가 많아서&nbsp;넘어간다.</li>
<li>Legacy format에서 <code>%property%</code> 형식으로 들어가는 내용과 동일하다고 보면&nbsp;될것같다.</li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#subtree"><code>subtree</code></a><ul>
<li>7.4.1 버전이후로 나온&nbsp;타입이다.</li>
<li>예제를 보면 더 쉽게 알수 있을&nbsp;것이다.</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span>set $!usr!tpl2!msg = $msg;
set $!usr!tpl2!dataflow = field($msg, 58, 2);
template(name=&quot;tpl2&quot; type=&quot;subtree&quot; subtree=&quot;$!usr!tpl2&quot;)
</pre></div>


<ul>
<li><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#string"><code>string</code></a><ul>
<li>Lagacy format 형식으로 쭉&nbsp;적는거다.</li>
<li>예제를&nbsp;보자</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span>template(name=&quot;tpl3&quot; type=&quot;string&quot;
         string=&quot;%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n&quot;
        )
</pre></div>


<ul>
<li><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#plugin"><code>plugin</code></a><ul>
<li>플러그인을 만들때 사용한다고 하는데&hellip; 쓸일이&nbsp;있을까??</li>
</ul>
</li>
</ul>
<h4 id="option"><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#options"><code>option</code></a></h4>
<p>예제로 이해하자. 필요하면 링크를 타고&nbsp;보고.</p>
<div class="codehilite"><pre><span></span>template(name=&quot;outfmt&quot; type=&quot;list&quot; option.jsonf=&quot;on&quot;) {
         property(outname=&quot;@timestamp&quot; name=&quot;timereported&quot; dateFormat=&quot;rfc3339&quot; format=&quot;jsonf&quot;)
         property(outname=&quot;host&quot; name=&quot;hostname&quot; format=&quot;jsonf&quot;)
         property(outname=&quot;severity&quot; name=&quot;syslogseverity-text&quot; caseConversion=&quot;upper&quot; format=&quot;jsonf&quot;)
         property(outname=&quot;facility&quot; name=&quot;syslogfacility-text&quot; format=&quot;jsonf&quot;)
         property(outname=&quot;syslog-tag&quot; name=&quot;syslogtag&quot; format=&quot;jsonf&quot;)
         property(outname=&quot;source&quot; name=&quot;app-name&quot; format=&quot;jsonf&quot;)
         property(outname=&quot;message&quot; name=&quot;msg&quot; format=&quot;jsonf&quot;)

 }
</pre></div>


<p>이렇게&nbsp;작성하면,</p>
<div class="codehilite"><pre><span></span>{
  &quot;@timestamp&quot;: &quot;2018-03-01T01:00:00+00:00&quot;,
  &quot;host&quot;: &quot;172.20.245.8&quot;,
  &quot;severity&quot;: &quot;DEBUG&quot;,
  &quot;facility&quot;: &quot;local4&quot;,
  &quot;syslog-tag&quot;: &quot;tag&quot;,
  &quot;source&quot;: &quot;tag&quot;,
  &quot;message&quot;: &quot; msgnum:00000000:&quot;
}
</pre></div>


<h3 id="legacy-format">Legacy&nbsp;Format</h3>
<p>6 이전 버전에서 사용하던 포멧이다. rsyslog template으로 해서 검색을 하면 가장 많이 나오는 포멧. 공식 문서에서는 사용하지 않을 것을&nbsp;권고하고있다.</p>
<p>아래의 예제는 파일에 로그를 작성하는 기본&nbsp;템플릿이다.</p>
<div class="codehilite"><pre><span></span>$template FileFormat,&quot;%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n&quot;
</pre></div>


<p>작성 요령은 <code>$template</code> 변수, <code>template 이름</code>, <code>"%PROPERTY_NAME[:FROM_CHAR:TO_CHAR:OPTION]%"</code>. 필요한 내용들을&nbsp;작성하면된다.</p>
<ul>
<li><code>Property</code> 내용은 <a href="http://www.rsyslog.com/doc/v8-stable/configuration/properties.html">도큐먼트</a>에&nbsp;작성되어있다.</li>
<li><code>FROM_CHAR</code>, <code>TO_CHAR</code> 부분은 어디서 어디까지&hellip; <code>%msg:1:2%</code>라고 작성했다면 메시지에서 첫번째 문자에서 두번째 문자까지 보여달라고 하는것. <code>FROM_CHAR</code> 을 작성하고 맨끝열까지 하고 싶다면, <code>TO_CHAR</code>에다가 숫자가 아닌 <code>$</code>를 입력하면 문자열의 맨마지막까지 보여주게 된다.<ul>
<li><code>FROM_CHAR</code> 부분에 <code>F</code> 입력<ul>
<li><code>%msg:F:2%</code> 라고 입력하면 <code>test\tchar</code>라면 <code>[test, char]</code>로 분리하고 <code>char</code>만&nbsp;보여주게된다.</li>
<li><code>F,ASCII_CODE</code>로 입력하면, 해당 문자로 나누게&nbsp;된다.</li>
</ul>
</li>
<li><code>FROM_CHAR</code> 부분에 <code>R</code> 입력<ul>
<li>정규식을 사용한다는&nbsp;것.</li>
<li>해당 내용은 man&nbsp;페이지를&hellip;</li>
</ul>
</li>
</ul>
</li>
<li><code>OPTION</code>은 <a href="http://manpages.ubuntu.com/manpages/xenial/en/man5/rsyslog.conf.5.html">man 페이지</a> Property Options 항목을&nbsp;확인하자.</li>
</ul>
<h3 id="_1">동적 파일 이름&nbsp;생성</h3>
<p>두가지 방식이 있다만, 첫번째 방식으로 작성해서 템플릿 구성을 맞추는게 좋을것으로&nbsp;보인다.</p>
<div class="codehilite"><pre><span></span>template (name=&quot;DynFile&quot; type=&quot;string&quot; string=&quot;/var/log/system-%HOSTNAME%.log&quot;)

$template DynFile,&quot;/var/log/system-%HOSTNAME%.log&quot;
</pre></div>


<h2 id="_2">결.</h2>
<p>Rsyslog는 지금 리눅스에서 기본적으로 사용되는 System logging 프로그램이다. 그렇기에 사용하기가 쉽고 쉽게 다가갈 수 있다.<br>
이런 것으로 우선 1차 정리하고 더 설정할 수 없는 것들은 프로그램에서 정리를 하거나 다른 프로그램을 사용하거나 해도 될듯. 무작정 패키지를 추가할 수 없는 시스템에서는 어쩔 수 없는&nbsp;선택이긴하다만&hellip;</p>
<p>삽질한 내용을 작성해 두려고 한건데&hellip; 글쓰는데 더 삽질을&hellip;&nbsp;ㅡ.ㅡa</p>
<p>다음번엔 원격 서버로 로컬 서버 로그를 넘기는 방법에 대해서 정리를 해볼까&hellip; 이 내용은&nbsp;많던데&hellip;</p>
<h2 id="_3">참고&nbsp;페이지</h2>
<ul>
<li><a href="http://www.rsyslog.com/doc">rsyslog doc&nbsp;homepage</a></li>
</ul>
      </div>
    </div>
      <div class="row">
        <p><i class="far fa-hand-spock"></i></p>
      </div>
    <div class="row article_meta">
      <div>
        <p>
          <i class="far fa-calendar-plus"></i> 18. 03. 01.
        <i class="fas fa-ellipsis-v"> </i>
          <i class="far fa-folder-open"></i> <a href="https://ujuc.github.io/category/operation.html">Operation</a>
        <i class="fas fa-ellipsis-v"> </i>
          <i class="fas fa-tags">
              <a href="https://ujuc.github.io/tag/syslog.html">syslog</a>
,               <a href="https://ujuc.github.io/tag/rsyslog.html">rsyslog</a>
,               <a href="https://ujuc.github.io/tag/log.html">log</a>
,               <a href="https://ujuc.github.io/tag/system.html">system</a>
,               <a href="https://ujuc.github.io/tag/linux.html">linux</a>
          </i>
        </p>
      </div>
    </div>

      <div class="article_comments">
<div id="disqus_thread"></div>
<script>

  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://ujucgithub.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>      </div>
  </div>
    </article>
  </div>

  <div class="container">
  </div>

  <!-- Title -->
  <div id="site_title" class="container">
    <div class="col-xs-offset-1 col-md-offset-1 col-xs-10 col-md-10">
      <div class="row">
        <hr />
        <h3><a href="https://ujuc.github.io" class="h3">잘 밤에 쓸데없는 생각하기...</a></h3>
      </div>
      <div class="row">
        <p>Anythink, Everythink!</p>
      </div>
      <div class="row">
          <span id="social"><a href="https://github.com/ujuc"><i class="fab fa-github-alt"></i> </a></span>
          <span id="social"><a href="https://kr.linkedin.com/in/sungjinkang"><i class="fab fa-linkedin-in"></i> </a></span>
      </div>
    </div>
  </div>

  <div id="site_footer" class="container">
<footer>
  <div class="col-xs-offset-1 col-md-offset-1 col-xs-10 col-md-10">
    <div class="row">
      <p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">(CC) BY-SA</a> ujuc. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>.</p>
    </div>
  </div>
</footer>  </div>

<!-- Javascript -->
<!-- Jquery -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>